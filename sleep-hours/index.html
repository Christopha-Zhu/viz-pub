<!DOCTYPE html>
<style>

path, line {
  
}

</style>
<body>
<svg id="mainimg" width=600 height=600></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>

function xpos(time, radius = 1) {
  return radius * Math.sin(2 * Math.PI * (time % 24)/24);
}

function ypos(time, radius = 1) {
  return -radius * Math.cos(2 * Math.PI * (time % 24)/24); 
}

var scale_color = d3.scaleLinear()
  .range([0.4, 1]);

var scale_timewidth = d3.scaleLinear()
  .range([0.000, 0.2]);

var svg = d3.select("#mainimg")
    .attr("viewBox", "-1.3, -1.3, 2.6, 2.6")
    .append("g");



d3.csv("data.csv", function(error, indata) {
  if (error) throw error;

  var data = [];
  d3.nest()
    .key(function(d) { return d.start; })
    .key(function(d) { return d.end; })
    .rollup(function(d) {
      return d3.sum(d, function(g) { return true ? +g.n : 0; })
    })
    .entries(indata)
    .forEach(function(d1) {
      d1.values.forEach(function(d2) {
        data.push({
          start: +d1.key,
          end: +d2.key,
          n: d2.value
        });
      });
    });

  data.forEach(function(d) {
    d.interval = d.end - d.start + (d.end > d.start ? 0 : 24);
    d.midpoint = (d.start + d.interval / 2) % 24;
    
  });

  data.sort(function(x, y) {
    return d3.ascending(x.n, y.n);
  })


  scale_color.domain([0, d3.max(data, function(d) { return d.n; })]);
  scale_timewidth.domain([0, d3.max(data, function(d) { return d.n; })]);


  svg.append("g").selectAll("dot")
    .data(d3.map(data, function(d) { return d.start; }).keys())
    .enter()
    .append("circle")
      .attr("r", 0.07)
      .attr("cx", function(d) { return xpos(d, 1.07); })
      .attr("cy", function(d) { return ypos(d, 1.07); })
      .attr("fill", "#fff")
      .on("mouseover", function(d) {
        svg.selectAll("path")
          .attr("opacity", function(dpath) { return dpath.start == d || dpath.end == d ? 1 : 0; });
      })
      .on("mouseout", function() {
        svg.selectAll("path")
          .attr("opacity", function(dpath) { return dpath.n > 0.01 ? 1 : 0; });
      });

  svg.append("g").selectAll("text")
    .data(d3.map(data, function(d) { return d.start; }).keys())
    .enter()
    .filter(function(d) { return Math.round(d) == d; })
    .append("text")
      .text(function(d) { return d; })
      .attr("x", function(d) { return xpos(d, 1.07); })
      .attr("y", function(d) { return ypos(d, 1.07); })
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("pointer-events", "none")
      .attr("font-size", 0.05);
  

  svg.selectAll("path")
    .data(data)
    .enter()
    .filter(function(d) {return d.n > 0.01; })
    .append("path")
      .attr("d", function(d) { return "M " + xpos(d.start - scale_timewidth(d.n)/2) + " "  + ypos(d.start - scale_timewidth(d.n)/2) + " " +
                                      "Q " + xpos(d.midpoint, 0) + " " + ypos(d.midpoint, 0) + " " +
                                             xpos(d.end + scale_timewidth(d.n)/2) + " " + ypos(d.end + scale_timewidth(d.n)/2) + " " +
                                      "L " + xpos(d.end - scale_timewidth(d.n)/2) + " " + ypos(d.end - scale_timewidth(d.n)/2) + " " +
                                      "Q " + xpos(d.midpoint, scale_timewidth(d.n)/4) + " " + ypos(d.midpoint, scale_timewidth(d.n)/4) + " " +
                                             xpos(d.start + scale_timewidth(d.n)/2) + " "  + ypos(d.start + scale_timewidth(d.n)/2) +
                                      "Z"; })
      .attr("stroke", "#fff")
      .attr("fill", function(d) { return d3.interpolateYlGnBu(scale_color(d.n)); } )
      .attr("stroke-width", 0.0018)
      .style("pointer-events", "none");



  
});


</script>
