<!DOCTYPE html>
<head>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<style>

body {
  font: 1em 'Lato', sans-serif;
}

text {
  font-family: Lato;
}

#legend text {
  font-size: 0.7em;
  fill: #333;
}




select {
    padding: 5px 8px;
    border: 1px solid black;
    background: transparent;
    appearance: none;
    -moz-appearance: none;
    -webkit-appearance: none;
}

select:focus {
    outline: none;
}

</style>

<link href="https://fonts.googleapis.com/css?family=Lato|Playfair+Display" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
</head>
<body>
<div class="container">
  <div class="row">
    <div class="col">
      <h1>Cycle of sleep</h1>
      <p>Testing testing</p>
    </div>
  </div>
  <div class="row">
    <div class="col">

      <select id="mainimg-age" onchange="redraw(); return true;">
        <option value="">All ages</option>
        <option value="20">15-24 yo</option>
        <option value="30">25-34 yo</option>
        <option value="40">35-44 yo</option>
        <option value="50">45-54 yo</option>
        <option value="60">55-64 yo</option>
        <option value="70">65-74 yo</option>
        <option value="80">75+ yo</option>
      </select>

      <select id="mainimg-occupation" onchange="redraw(); return true;">
        <option value="">All occupations</option>
      </select>

      <select id="mainimg-wday" onchange="redraw(); return true;">
        <option value="">All days</option>
        <option value="1">Sunday</option>
        <option value="2">Monday</option>
        <option value="3">Tuesday</option>
        <option value="4">Wednesday</option>
        <option value="5">Thursday</option>
        <option value="6">Friday</option>
        <option value="7">Saturday</option>
        
      </select>

    </div>
  </div>
  <div class="row">
    <div class="col">
      <svg id="mainimg" width=600 height=600>
        <g id="legend" transform="translate(-1.2 1.0) scale(0.004)"></g>
      </svg>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <p>Testing testing</p>
    </div>
  </div>
</div>








<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.min.js"></script>
<script>



function xpos(time, radius = 1) {
  return radius * Math.sin(2 * Math.PI * time/24);
}

function ypos(time, radius = 1) {
  return -radius * Math.cos(2 * Math.PI * time/24); 
}

var scale_color = d3.scaleSequential(function(t) {
    return d3.interpolateYlGnBu(t * 0.7 + 0.3)
  })
  //.range([0.3, 1])
  //.range(["rgb(46, 73, 123)", "rgb(71, 187, 94)"])
  .domain([0, 0.03]); // percent

  //d3.interpolateYlGnBu(

var scale_timewidth = d3.scaleLinear()
  .range([0.000, 0.2])
  .domain([0, 0.03]); // percent

d3.select("#legend")
  .call(
    d3.legendColor()
      .cells(4)
      .shapeWidth(20)
      .orient("horizontal")
      .labelFormat(d3.format(".0%"))
      .scale(scale_color)
  );



var svg = d3.select("#mainimg")
    .attr("viewBox", "-1.2, -1.2, 2.4, 2.4")
    .append("g");

var RAWDATA,
    TIMELINES;

function aggdata() {
  var data = [];

  function settings_filter(d) {
    age = document.getElementById("mainimg-age").value;
    if (age != "") {
      if (d.age != age) {
        return false;
      }
    }

    occupation = document.getElementById("mainimg-occupation").value;
    if (occupation != "") {
      if (d.occupation != occupation) {
        return false;
      }
    }

    wday = document.getElementById("mainimg-wday").value;
    if (wday != '') {
      if (d.wday != wday) {
        return false;
      }
    }

    return true;
  }

  d3.nest()
    .key(function(d) { return d.start; })
    .key(function(d) { return d.end; })
    .rollup(function(d) {
      return d3.sum(d, function(g) { return settings_filter(g) ? +g.n : 0; })
    })
    .entries(RAWDATA)
    .forEach(function(d1) {
      d1.values.forEach(function(d2) {
        data.push({
          start: +d1.key,
          end: +d2.key,
          n: d2.value
        });
      });
    });

  var total = d3.sum(data, function(d2) { return d2.n; });
  data.forEach(function(d) {
    d.interval = d.end - d.start + (d.end > d.start ? 0 : 24);
    d.midpoint = (d.start + d.interval / 2) % 24;
    d.n = d.n / total;
  });


  data.sort(function(x, y) {
    return d3.ascending(x.n, y.n);
  })

  return data.filter(function(d) {return d.n > 0.0001; });
}


function redraw() {

  data = aggdata();

  TIMELINES.selectAll("path").remove();

  TIMELINES.selectAll("path")
    .data(data, function(d) { return "" + d.start + "." + d.end; })
    .enter()
    .append("path")
      .classed("timeline", true)
      .attr("stroke", "#fff")
      .attr("stroke-width", 0.0018)
      .style("pointer-events", "none")
      .attr("d", function(d) { return "M " + xpos(d.start - scale_timewidth(d.n)/2) + " "  + ypos(d.start - scale_timewidth(d.n)/2) + " " +
                                      "Q " + xpos(d.midpoint, 0) + " " + ypos(d.midpoint, 0) + " " +
                                             xpos(d.end + scale_timewidth(d.n)/2) + " " + ypos(d.end + scale_timewidth(d.n)/2) + " " +
                                      "L " + xpos(d.end - scale_timewidth(d.n)/2) + " " + ypos(d.end - scale_timewidth(d.n)/2) + " " +
                                      "Q " + xpos(d.midpoint, scale_timewidth(d.n)/3.5) + " " + ypos(d.midpoint, scale_timewidth(d.n)/3.5) + " " +
                                             xpos(d.start + scale_timewidth(d.n)/2) + " "  + ypos(d.start + scale_timewidth(d.n)/2) +
                                      "Z"; })
      .attr("fill", function(d) { return scale_color(d.n); } );
}


d3.csv("data.csv", function(error, indata) {
  if (error) throw error;

  RAWDATA = indata;
  var data = aggdata();

  d3.select("#mainimg-occupation")
    .selectAll("option")
    .data(d3.map(indata, function(d){return d.occupation;}).keys())
    .enter()
    .append("option")
    .attr("value", function(d) { return d; })
    .text(function(d) { return d; });

  
  svg.append("g").selectAll("path")
    .data([...Array(48).keys()])
    .enter()
    .append("path")
      .attr("d", function(d) { return "M 0 0" +
                                      " L " + xpos(d/2 + 0.25, 1.18) + " " + ypos(d/2 + 0.25, 1.18) +
                                      " L " + xpos(d/2 - 0.25, 1.18) + " " + ypos(d/2 - 0.25, 1.18) +
                                      " Z"; })
      .attr("fill", "#fff")
      .on("mouseover", function(d) {
        svg.selectAll(".timeline")
          .attr("opacity", function(dpath) { return dpath.start == d/2 || dpath.end == d/2 ? 1 : 0; });
      })
      .on("mouseout", function() {
        svg.selectAll(".timeline")
          .attr("opacity", 1);
      });

  svg.append("g").selectAll("text")
    .data([...Array(24).keys()])
    .enter()
    .filter(function(d) { return Math.round(d) == d; })
    .append("text")
      .text(function(d) { return d; })
      .attr("x", function(d) { return xpos(d, 1.07); })
      .attr("y", function(d) { return ypos(d, 1.07); })
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("pointer-events", "none")
      .attr("font-size", 0.05);
  
  TIMELINES = svg.append("g");

  redraw();






  
});


</script>
</body>
</html>